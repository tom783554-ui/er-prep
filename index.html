<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ER Prep Snapshot ‚Äì Your Personal ER Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --surface: #ffffff;
      --surface-soft: #f9fafb;
      --border: #e5e7eb;
      --accent: #0ea5e9;
      --accent-deep: #0369a1;
      --accent-soft: #e0f2fe;
      --text: #0f172a;
      --muted: #6b7280;
      --danger: #b91c1c;
      --danger-soft: #fee2e2;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
      background:
        radial-gradient(circle at top, #1f2937 0, #020617 40%, #020617 100%);
      color: var(--text);
    }

    .page {
      max-width: 1040px;
      margin: 18px auto 32px;
      padding: 22px 22px 28px;
      background: radial-gradient(circle at top left, #eff6ff 0, #ffffff 45%, #ffffff 100%);
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.35),
        0 0 0 1px rgba(15, 23, 42, 0.03);
    }

    h1 {
      font-size: 2.1rem;
      margin: 0 0 0.15rem;
      letter-spacing: -0.04em;
      color: var(--text);
    }

    h2 {
      font-size: 1rem;
      margin-top: 1.35rem;
      margin-bottom: 0.3rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent-deep);
      font-weight: 800;
    }

    p.small {
      font-size: 0.87rem;
      color: var(--muted);
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
      margin-bottom: 0.4rem;
    }

    .subtitle-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(14, 165, 233, 0.08);
      color: var(--accent-deep);
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-bottom: 0.4rem;
    }

    .subtitle-chip span {
      font-size: 0.9rem;
    }

    .disclaimer-block {
      border-left: 4px solid var(--danger);
      padding: 9px 11px;
      background: var(--danger-soft);
      border-radius: 12px;
      font-size: 0.85rem;
      color: var(--danger);
      margin-bottom: 0.95rem;
    }

    .layout-two-col {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 20px;
      margin-top: 8px;
    }

    .layout-two-col .col {
      min-width: 0;
    }

    .section-card {
      border: 1px solid var(--border);
      padding: 12px 12px 14px;
      margin-top: 8px;
      border-radius: 14px;
      background: linear-gradient(145deg, var(--surface-soft), #ffffff);
      box-shadow:
        0 10px 24px rgba(15, 23, 42, 0.06),
        0 0 0 1px rgba(255, 255, 255, 0.9);
    }

    label {
      display: block;
      margin-top: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #111827;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 7px 9px;
      margin-top: 4px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 0.9rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease, transform 0.06s ease;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft), 0 4px 10px rgba(14, 165, 233, 0.25);
      background: #ffffff;
      transform: translateY(-1px);
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > div {
      flex: 1;
      min-width: 0;
    }

    button {
      margin-top: 12px;
      margin-right: 8px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid var(--accent-deep);
      background: linear-gradient(135deg, var(--accent), var(--accent-deep));
      color: #ffffff;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      box-shadow: 0 8px 22px rgba(14, 165, 233, 0.45);
      transition: transform 0.07s ease, box-shadow 0.07s ease, background-position 0.1s ease, filter 0.1s ease;
      background-size: 150% 150%;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(14, 165, 233, 0.5);
      filter: brightness(1.03);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 5px 14px rgba(14, 165, 233, 0.35);
      filter: brightness(0.98);
    }

    .secondary-button {
      background: #ffffff;
      color: var(--accent-deep);
      border-color: var(--accent-soft);
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
      background-image: none;
    }

    .secondary-button:hover {
      background: var(--accent-soft);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }

    #summaryBox,
    #callScriptBox {
      margin-top: 12px;
      white-space: pre-wrap;
      border: 1px solid var(--border);
      padding: 10px;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 0.85rem;
      background: #f9fafb;
      border-radius: 10px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.7);
    }

    .actions-row {
      margin-top: 8px;
    }

    .actions-row button {
      margin-top: 6px;
    }

    .no-print {
      display: block;
    }

    /* Triage snapshot card */

    .triage-card {
      font-size: 0.85rem;
      background: radial-gradient(circle at top left, #e0f2fe 0, #f1f5f9 45%, #f1f5f9 100%);
      border-radius: 14px;
      border: 1px solid #d4d4ff;
      padding: 10px 12px 12px;
      box-shadow:
        0 10px 26px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    .triage-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
    }

    .triage-title {
      font-weight: 750;
      font-size: 0.96rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #0f172a;
    }

    .triage-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 9px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .triage-pill span {
      font-size: 0.9rem;
    }

    .triage-sub {
      text-align: right;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .triage-section-title {
      font-weight: 700;
      margin-top: 6px;
      margin-bottom: 2px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #4b5563;
    }

    .triage-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 2px;
    }

    .triage-label {
      font-weight: 600;
    }

    .triage-value {
      text-align: right;
      white-space: pre-wrap;
      flex: 1;
      margin-left: 8px;
    }

    .triage-multiline {
      white-space: pre-wrap;
      margin-bottom: 4px;
    }

    .triage-muted {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      .page {
        margin: 10px;
        padding: 14px 12px 20px;
        border-radius: 14px;
      }
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .layout-two-col {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (min-width: 769px) {
      .layout-two-col {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      }
    }

    @media print {
      body {
        max-width: none;
        margin: 0;
        padding: 8px;
        background: #ffffff;
      }
      .page {
        box-shadow: none;
        border-radius: 0;
        border: none;
        margin: 0;
        padding: 8px;
      }
      .no-print {
        display: none !important;
      }
      #summaryBox,
      #callScriptBox {
        border: none;
        background: white;
        font-size: 0.9rem;
      }
      .triage-card {
        background: #ffffff;
        border-color: #000000;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header-row">
      <div>
        <div class="subtitle-chip no-print">
          <span>‚úö</span> ER-ready patient summary
        </div>
        <h1>ER Prep Snapshot</h1>
        <p class="small">
          A quick, patient-filled worksheet to organize your history, medications, allergies, and what is happening today before an Emergency Room visit.
          It runs entirely in your browser; we do <strong>not</strong> store or receive your information.
        </p>
      </div>
    </div>

    <p class="small">
      You can save your baseline information on <strong>this device only</strong>. You decide if you want to show the summary to ER staff, print it, or read it over the phone.
    </p>

    <div class="disclaimer-block">
      <strong>Emergency warning:</strong> This does <strong>not</strong> replace 911.  
      If your symptoms are severe, sudden, or getting worse (for example chest pain, trouble breathing, stroke-like symptoms, severe bleeding, major trauma), call 911 immediately.  
      Do not delay going to the ER to fill out this form.
    </div>

    <!-- BASELINE + TODAY'S VISIT SIDE BY SIDE -->
    <div class="layout-two-col">
      <!-- COLUMN 1: BASELINE -->
      <div class="col">
        <h2>1. Baseline information</h2>
        <p class="small">
          Fill this out once when you are well. You can update and save it on <em>this device only</em>.
        </p>

        <div class="section-card">
          <label>
            Full name
            <input type="text" id="base_name" />
          </label>

          <div class="row">
            <div>
              <label>
                Date of birth
                <input type="text" id="base_dob" placeholder="YYYY-MM-DD or MM/DD/YYYY" />
              </label>
            </div>
            <div>
              <label>
                Sex
                <select id="base_sex">
                  <option value="">Select‚Ä¶</option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>Other</option>
                  <option>Prefer not to say</option>
                </select>
              </label>
            </div>
          </div>

          <div class="row">
            <div>
              <label>
                Height
                <input type="text" id="base_height" placeholder="e.g. 5'9&quot; or 175 cm" />
              </label>
            </div>
            <div>
              <label>
                Weight
                <input type="text" id="base_weight" placeholder="e.g. 180 lb or 82 kg" />
              </label>
            </div>
          </div>

          <label>
            Chronic conditions (heart, lung, kidney problems; diabetes; cancer; other important diagnoses)
            <textarea id="base_conditions" placeholder="Example: Coronary artery disease with stent 2018; heart failure; COPD; type 2 diabetes; CKD stage 3."></textarea>
          </label>

          <label>
            Regular medications (include blood thinners like Eliquis, Xarelto, warfarin, Plavix, etc.)
            <textarea id="base_meds" placeholder="Example: Aspirin 81 mg; Atorvastatin 40 mg; Metoprolol 50 mg BID; Lisinopril 10 mg; Metformin 1000 mg BID; Eliquis 5 mg BID."></textarea>
          </label>

          <label>
            Medication / food / contrast allergies (and what happened)
            <textarea id="base_allergies" placeholder="Example: Penicillin (anaphylaxis); IV contrast (hives); NKDA if none."></textarea>
          </label>

          <label>
            Primary doctor and important specialists
            <textarea id="base_doctors" placeholder="Example: Dr. Smith (PCP); Dr. Lee (cardiologist)."></textarea>
          </label>

          <label>
            Emergency contact (name and phone)
            <textarea id="base_contact" placeholder="Example: Jane Doe (spouse), 555-123-4567."></textarea>
          </label>

          <button class="no-print" type="button" onclick="saveBaseline()">üíæ Save baseline on this device</button>
          <button class="no-print secondary-button" type="button" onclick="loadBaseline()">‚ü≥ Load saved baseline</button>
          <p class="small">
            Baseline is stored only in this browser on this device (local storage). Clearing browser data will erase it.
          </p>
        </div>
      </div>

      <!-- COLUMN 2: TODAY'S VISIT -->
      <div class="col">
        <h2>2. Today‚Äôs visit</h2>
        <p class="small">
          Use this when you are going to the ER by car (and it is safe to use your phone). Keep it brief and honest.
        </p>

        <div class="section-card">
          <label>
            Which ER are you going to? (name and city)
            <input type="text" id="visit_er" placeholder="Example: Metro General ER, Springfield" />
          </label>

          <label>
            What is happening right now? (main problem)
            <textarea id="visit_chief" placeholder="Example: Chest pain for 40 minutes, pressure in the center of the chest."></textarea>
          </label>

          <label>
            When did this start and how?
            <textarea id="visit_onset" placeholder="Example: Started about 40 minutes ago while walking up stairs; not relieved by rest."></textarea>
          </label>

          <label>
            Where is the pain or problem, and does it go anywhere? (location / radiation)
            <textarea id="visit_location" placeholder="Example: Center of chest, sometimes going to left arm and jaw."></textarea>
          </label>

          <div class="row">
            <div>
              <label>
                How bad is the pain right now? (0‚Äì10)
                <input type="number" id="visit_severity" min="0" max="10" placeholder="Example: 8" />
              </label>
            </div>
            <div>
              <label>
                About how long until you arrive? (minutes, optional)
                <input type="number" id="visit_eta" min="0" max="240" placeholder="Example: 20" />
              </label>
            </div>
          </div>

          <label>
            Other symptoms (shortness of breath, sweating, nausea, weakness, fever, etc.)
            <textarea id="visit_symptoms" placeholder="Example: Shortness of breath and sweating; no vomiting; no fainting."></textarea>
          </label>

          <label>
            What have you taken or done so far?
            <textarea id="visit_taken" placeholder="Example: Took 2 baby aspirins (162 mg) at home; sat and rested; no nitro available."></textarea>
          </label>

          <label>
            What worries you the most right now?
            <textarea id="visit_worries" placeholder="Example: Feels like the chest pain I had with my heart attack in 2018."></textarea>
          </label>

          <label>
            Recent surgeries or procedures (last 3 months, if any)
            <textarea id="visit_surgeries" placeholder="Example: Knee replacement 3 weeks ago; dialysis catheter placed last month."></textarea>
          </label>

          <label>
            Code status / DNR (if already decided)
            <textarea id="visit_code" placeholder="Example: Full code; or DNR-comfort care only; or 'not sure / not discussed yet'."></textarea>
          </label>

          <button class="no-print" type="button" onclick="generateSummary()">üìù Generate written summary + triage snapshot</button>
          <button class="no-print secondary-button" type="button" onclick="window.print()">üñ® Print</button>
        </div>
      </div>
    </div>

    <!-- TRIAGE SNAPSHOT OUTPUT -->
    <h2>3. Triage snapshot (for triage nurse)</h2>
    <p class="small no-print">
      When you click ‚ÄúGenerate written summary + triage snapshot‚Äù, this section shows a quick, nurse-facing view of your situation. 
      It is <strong>patient-entered and unverified</strong>.
    </p>
    <div id="triageSnapshot" class="triage-card">
      <p class="small">
        (Click ‚ÄúGenerate written summary + triage snapshot‚Äù above to populate this triage-style summary.)
      </p>
    </div>

    <!-- SUMMARY OUTPUT -->
    <h2>4. Written summary</h2>
    <p class="small no-print">
      Show this on your phone, print it, or copy and paste it into a message/portal if you wish.
    </p>
    <div id="summaryBox">
      (Your summary will appear here after you click "Generate written summary + triage snapshot".)
    </div>
    <div class="actions-row no-print">
      <button type="button" class="secondary-button" onclick="copySummary()">üìã Copy summary text</button>
      <button type="button" class="secondary-button" onclick="openEmailDraft()">‚úâÔ∏è Open email draft with summary</button>
      <button type="button" class="secondary-button" onclick="downloadSummaryTxt()">‚¨áÔ∏è Download summary as .txt</button>
    </div>

    <!-- CALL SCRIPT OUTPUT -->
    <h2>5. Call script</h2>
    <p class="small no-print">
      If you call the ER ahead of time, you can read this script out loud. It helps you say the important things clearly.
    </p>
    <div id="callScriptBox">
      (Your call script will appear here after you generate the summary.)
    </div>
    <div class="actions-row no-print">
      <button type="button" class="secondary-button" onclick="copyCallScript()">üìã Copy call script</button>
    </div>
  </div>

  <script>
    const BASELINE_KEY = "er_prep_baseline_v1";
    let lastSummaryText = "";
    let lastCallScriptText = "";

    function saveBaseline() {
      const baseline = {
        name: document.getElementById("base_name").value.trim(),
        dob: document.getElementById("base_dob").value.trim(),
        sex: document.getElementById("base_sex").value,
        height: document.getElementById("base_height").value.trim(),
        weight: document.getElementById("base_weight").value.trim(),
        conditions: document.getElementById("base_conditions").value.trim(),
        meds: document.getElementById("base_meds").value.trim(),
        allergies: document.getElementById("base_allergies").value.trim(),
        doctors: document.getElementById("base_doctors").value.trim(),
        contact: document.getElementById("base_contact").value.trim()
      };
      try {
        localStorage.setItem(BASELINE_KEY, JSON.stringify(baseline));
        alert("Baseline saved on this device.");
      } catch (e) {
        alert("Could not save baseline (local storage error).");
      }
    }

    function loadBaseline() {
      try {
        const raw = localStorage.getItem(BASELINE_KEY);
        if (!raw) {
          alert("No baseline saved on this device.");
          return;
        }
        const b = JSON.parse(raw);
        document.getElementById("base_name").value = b.name || "";
        document.getElementById("base_dob").value = b.dob || "";
        document.getElementById("base_sex").value = b.sex || "";
        document.getElementById("base_height").value = b.height || "";
        document.getElementById("base_weight").value = b.weight || "";
        document.getElementById("base_conditions").value = b.conditions || "";
        document.getElementById("base_meds").value = b.meds || "";
        document.getElementById("base_allergies").value = b.allergies || "";
        document.getElementById("base_doctors").value = b.doctors || "";
        document.getElementById("base_contact").value = b.contact || "";
        alert("Baseline loaded from this device.");
      } catch (e) {
        alert("Could not load baseline (local storage error).");
      }
    }

    function valueOrDash(v) {
      const t = (v || "").trim();
      return t === "" ? "‚Äî" : t;
    }

    function buildAnticoagStatus(medsText) {
      const t = (medsText || "").toLowerCase();
      if (!t) return "Not listed";
      const keywords = [
        "warfarin","coumadin","eliquis","apixaban","xarelto","rivaroxaban",
        "pradaxa","dabigatran","lovenox","enoxaparin","heparin",
        "plavix","clopidogrel","brilinta","ticagrelor","effient","prasugrel"
      ];
      const found = keywords.filter(k => t.includes(k));
      if (found.length > 0) {
        return "Yes (mentions: " + found.join(", ") + ")";
      }
      return "Not obvious from meds list";
    }

    function updateTriageSnapshot(data) {
      const container = document.getElementById("triageSnapshot");

      const anticoagStatus = buildAnticoagStatus(data.base_meds);

      const name = valueOrDash(data.base_name);
      const dob = valueOrDash(data.base_dob);
      const sex = valueOrDash(data.base_sex);
      const chief = valueOrDash(data.visit_chief);
      const onset = valueOrDash(data.visit_onset);
      const loc = valueOrDash(data.visit_location);
      const sev = valueOrDash(data.visit_severity);
      const symp = valueOrDash(data.visit_symptoms);
      const worries = valueOrDash(data.visit_worries);
      const cond = valueOrDash(data.base_conditions);
      const meds = valueOrDash(data.base_meds);
      const allergies = valueOrDash(data.base_allergies);
      const surgeries = valueOrDash(data.visit_surgeries);
      const code = valueOrDash(data.visit_code);
      const eta = valueOrDash(data.visit_eta);
      const er = valueOrDash(data.visit_er);
      const contact = valueOrDash(data.base_contact);

      container.innerHTML = `
        <div class="triage-header">
          <div>
            <div class="triage-title">Triage snapshot (patient-provided)</div>
            <div class="triage-pill"><span>‚ö†</span> Patient-entered ¬∑ unverified</div>
          </div>
          <div class="triage-sub">
            <div>${name}</div>
            <div>DOB: ${dob}${sex !== "‚Äî" ? " ¬∑ " + sex : ""}</div>
          </div>
        </div>

        <div class="triage-section-title">Presenting problem</div>
        <div class="triage-multiline">
          <span class="triage-label">Chief complaint: </span>${chief}
        </div>
        <div class="triage-multiline">
          <span class="triage-label">Onset / time course: </span>${onset}
        </div>
        <div class="triage-multiline">
          <span class="triage-label">Location / radiation: </span>${loc}
        </div>
        <div class="triage-row">
          <div class="triage-label">Pain 0‚Äì10:</div>
          <div class="triage-value">${sev}</div>
        </div>
        <div class="triage-multiline">
          <span class="triage-label">Other symptoms: </span>${symp}
        </div>
        <div class="triage-multiline">
          <span class="triage-label">What worries patient most: </span>${worries}
        </div>

        <div class="triage-section-title">Background</div>
        <div class="triage-multiline">
          <span class="triage-label">Key conditions: </span>${cond}
        </div>
        <div class="triage-row">
          <div class="triage-label">On blood thinners:</div>
          <div class="triage-value">${anticoagStatus}</div>
        </div>
        <div class="triage-multiline">
          <span class="triage-label">Medications: </span>${meds}
        </div>
        <div class="triage-multiline">
          <span class="triage-label">Allergies: </span>${allergies}
        </div>

        <div class="triage-section-title">Recent interventions / preferences</div>
        <div class="triage-multiline">
          <span class="triage-label">Recent surgeries / procedures: </span>${surgeries}
        </div>
        <div class="triage-multiline">
          <span class="triage-label">Code status / DNR: </span>${code}</div>

        <div class="triage-section-title">Logistics</div>
        <div class="triage-row">
          <div class="triage-label">Planned ER:</div>
          <div class="triage-value">${er}</div>
        </div>
        <div class="triage-row">
          <div class="triage-label">Approx. ETA (min):</div>
          <div class="triage-value">${eta}</div>
        </div>
        <div class="triage-multiline">
          <span class="triage-label">Emergency contact: </span>${contact}
        </div>
        <div class="triage-muted">
          This card is for triage context only. Information is patient-entered and may be incomplete or inaccurate.
        </div>
      `;
    }

    function generateSummary() {
      const base_name = document.getElementById("base_name").value.trim();
      const base_dob = document.getElementById("base_dob").value.trim();
      const base_sex = document.getElementById("base_sex").value;
      const base_height = document.getElementById("base_height").value.trim();
      const base_weight = document.getElementById("base_weight").value.trim();
      const base_conditions = document.getElementById("base_conditions").value.trim();
      const base_meds = document.getElementById("base_meds").value.trim();
      const base_allergies = document.getElementById("base_allergies").value.trim();
      const base_doctors = document.getElementById("base_doctors").value.trim();
      const base_contact = document.getElementById("base_contact").value.trim();

      const visit_er = document.getElementById("visit_er").value.trim();
      const visit_chief = document.getElementById("visit_chief").value.trim();
      const visit_onset = document.getElementById("visit_onset").value.trim();
      const visit_location = document.getElementById("visit_location").value.trim();
      const visit_severity = document.getElementById("visit_severity").value.trim();
      const visit_symptoms = document.getElementById("visit_symptoms").value.trim();
      const visit_taken = document.getElementById("visit_taken").value.trim();
      const visit_worries = document.getElementById("visit_worries").value.trim();
      const visit_eta = document.getElementById("visit_eta").value.trim();
      const visit_surgeries = document.getElementById("visit_surgeries").value.trim();
      const visit_code = document.getElementById("visit_code").value.trim();

      const lines = [];

      // HEADER
      lines.push("ER SNAPSHOT ‚Äì PATIENT SUMMARY");
      lines.push("================================");
      if (base_name) lines.push(`Name: ${base_name}`);
      if (base_dob) lines.push(`Date of birth: ${base_dob}`);
      if (base_sex) lines.push(`Sex: ${base_sex}`);
      if (base_height || base_weight) {
        lines.push(
          "Height / Weight: " +
          [base_height || null, base_weight || null].filter(Boolean).join(" | ")
        );
      }
      if (visit_er) lines.push(`Planned ER: ${visit_er}`);
      if (visit_eta) lines.push(`Approximate ETA: about ${visit_eta} minute(s) from now.`);
      lines.push("");

      // CURRENT EPISODE
      lines.push("CURRENT PROBLEM");
      lines.push("---------------");
      lines.push(visit_chief || "(not specified)");
      lines.push("");
      lines.push("Onset (when and how it started):");
      lines.push(visit_onset || "(not specified)");
      lines.push("");
      lines.push("Location / radiation:");
      lines.push(visit_location || "(not specified)");
      lines.push("");
      lines.push("Pain severity (0‚Äì10):");
      lines.push(visit_severity || "(not specified)");
      lines.push("");
      lines.push("Other symptoms:");
      lines.push(visit_symptoms || "(not specified)");
      lines.push("");
      lines.push("What I have taken or done so far:");
      lines.push(visit_taken || "(not specified)");
      lines.push("");
      lines.push("What worries me the most:");
      lines.push(visit_worries || "(not specified)");
      lines.push("");

      // BASELINE
      lines.push("CHRONIC CONDITIONS");
      lines.push("------------------");
      lines.push(base_conditions || "(not specified)");
      lines.push("");
      lines.push("REGULAR MEDICATIONS");
      lines.push("-------------------");
      lines.push(base_meds || "(not specified)");
      lines.push("");
      lines.push("ALLERGIES");
      lines.push("---------");
      lines.push(base_allergies || "(not specified)");
      lines.push("");
      lines.push("DOCTORS");
      lines.push("-------");
      lines.push(base_doctors || "(not specified)");
      lines.push("");
      lines.push("EMERGENCY CONTACT");
      lines.push("-----------------");
      lines.push(base_contact || "(not specified)");
      lines.push("");
      lines.push("RECENT SURGERIES / PROCEDURES (last 3 months)");
      lines.push("---------------------------------------------");
      lines.push(visit_surgeries || "(not specified)");
      lines.push("");
      lines.push("CODE STATUS / DNR");
      lines.push("-----------------");
      lines.push(visit_code || "(not specified)");
      lines.push("");
      lines.push("Note: This summary was prepared by the patient or family to help explain the situation quickly.");
      lines.push("It does not replace standard triage or medical evaluation.");

      lastSummaryText = lines.join("\n");
      document.getElementById("summaryBox").textContent = lastSummaryText;

      // Update triage snapshot view
      updateTriageSnapshot({
        base_name,
        base_dob,
        base_sex,
        base_conditions,
        base_meds,
        base_allergies,
        base_contact,
        visit_er,
        visit_chief,
        visit_onset,
        visit_location,
        visit_severity,
        visit_symptoms,
        visit_taken,
        visit_worries,
        visit_eta,
        visit_surgeries,
        visit_code
      });

      // Auto-generate call script at the same time
      generateCallScript();
    }

    function generateCallScript() {
      const base_name = document.getElementById("base_name").value.trim();
      const base_dob = document.getElementById("base_dob").value.trim();
      const base_sex = document.getElementById("base_sex").value;
      const base_conditions = document.getElementById("base_conditions").value.trim();
      const base_meds = document.getElementById("base_meds").value.trim();
      const base_allergies = document.getElementById("base_allergies").value.trim();

      const visit_er = document.getElementById("visit_er").value.trim();
      const visit_chief = document.getElementById("visit_chief").value.trim();
      const visit_onset = document.getElementById("visit_onset").value.trim();
      const visit_symptoms = document.getElementById("visit_symptoms").value.trim();
      const visit_taken = document.getElementById("visit_taken").value.trim();
      const visit_worries = document.getElementById("visit_worries").value.trim();
      const visit_eta = document.getElementById("visit_eta").value.trim();

      const parts = [];

      // Opening
      parts.push("Hi, my name is " + (base_name || "[your name]") + ".");
      if (base_dob) {
        parts.push("My date of birth is " + base_dob + ".");
      }
      if (base_sex) {
        parts.push("I am " + base_sex.toLowerCase() + ".");
      }
      if (visit_er) {
        parts.push("I am on my way to your emergency department at " + visit_er + ".");
      } else {
        parts.push("I am on my way to the emergency department.");
      }

      // Current problem
      parts.push("I am calling because " + (visit_chief || "I am having a medical problem") + ".");
      if (visit_onset) {
        parts.push("It started " + visit_onset + ".");
      }
      if (visit_symptoms) {
        parts.push("Other symptoms: " + visit_symptoms + ".");
      }

      // What they've done
      if (visit_taken) {
        parts.push("So far I have taken or done: " + visit_taken + ".");
      }

      // History / meds / allergies
      if (base_conditions) {
        parts.push("My main medical problems are: " + base_conditions + ".");
      }
      if (base_meds) {
        parts.push("My regular medications include: " + base_meds + ".");
      }
      if (base_allergies) {
        parts.push("My allergies are: " + base_allergies + ".");
      }

      // Worries and ETA
      if (visit_worries) {
        parts.push("What worries me the most is: " + visit_worries + ".");
      }
      if (visit_eta) {
        parts.push("We expect to arrive in about " + visit_eta + " minute(s).");
      }

      parts.push("Thank you.");

      lastCallScriptText = parts.join(" ");
      document.getElementById("callScriptBox").textContent = lastCallScriptText;
    }

    function copyToClipboard(text, label) {
      if (!text) {
        alert("Nothing to copy yet. Please generate the " + label + " first.");
        return;
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert(label + " copied to clipboard."))
          .catch(() => fallbackCopy(text, label));
      } else {
        fallbackCopy(text, label);
      }
    }

    function fallbackCopy(text, label) {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.top = "-1000px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try {
        document.execCommand("copy");
        alert(label + " copied to clipboard.");
      } catch (e) {
        alert("Could not copy " + label + " on this device.");
      }
      document.body.removeChild(ta);
    }

    function copySummary() {
      if (!lastSummaryText) generateSummary();
      copyToClipboard(lastSummaryText, "Summary");
    }

    function copyCallScript() {
      if (!lastCallScriptText) generateCallScript();
      copyToClipboard(lastCallScriptText, "Call script");
    }

    function openEmailDraft() {
      if (!lastSummaryText) generateSummary();
      if (!lastSummaryText) {
        alert("No summary available to email.");
        return;
      }
      const base_name = document.getElementById("base_name").value.trim();
      const subject = encodeURIComponent("ER Snapshot for " + (base_name || "patient"));
      const body = encodeURIComponent(lastSummaryText + "\n\n(Generated with ER Prep Snapshot)");
      window.location.href = "mailto:?subject=" + subject + "&body=" + body;
    }

    function downloadSummaryTxt() {
      if (!lastSummaryText) generateSummary();
      if (!lastSummaryText) {
        alert("No summary available to download.");
        return;
      }
      const blob = new Blob([lastSummaryText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "er_snapshot.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    (function autoLoadBaselineOnce() {
      try {
        const raw = localStorage.getItem(BASELINE_KEY);
        if (!raw) return;
        const b = JSON.parse(raw);
        document.getElementById("base_name").value = b.name || "";
        document.getElementById("base_dob").value = b.dob || "";
        document.getElementById("base_sex").value = b.sex || "";
        document.getElementById("base_height").value = b.height || "";
        document.getElementById("base_weight").value = b.weight || "";
        document.getElementById("base_conditions").value = b.conditions || "";
        document.getElementById("base_meds").value = b.meds || "";
        document.getElementById("base_allergies").value = b.allergies || "";
        document.getElementById("base_doctors").value = b.doctors || "";
        document.getElementById("base_contact").value = b.contact || "";
      } catch (e) {
        // ignore
      }
    })();
  </script>
</body>
</html>
